// "M207.8721324350939 27.917826920259323Q446.717838156399 32.35801629619725 697.399154427173 28.293540358259147C728.4574858652891 26.879503669871788 739.3640354115346 46.57634039943249 738.9979073128364 68.310207767613Q736.183031031041 222.51459110637822 724.8272712074668 431.9775942002012C725.8975804350478 466.0694784282333 716.2212511422277 468.85114399523 714.5967238030761 473.1512572414507C759.9782139308417 482.0423968880772 761.6350454138384 537.7279818981585 768.2270365134065 572.5477199864122C780.8273807948459 651.3315793520422 774.8659794687167 786.0475625285775 737.1572794378717 807.715886245039C699.3796580112419 830.8995063695895 555.821806114115 858.1093414717326 452.672308141119 865.3448080644633C354.685502981642 854.2243436652541 189.99930596978263 823.0828743930684 159.42486324448106 791.8210441457624C130.12700722230318 762.1985117105605 124.80377709111514 615.6430448164913 155.63616981752497 510.70380617856466C163.26817839724507 489.15230476915104 178.15898645081157 472.4310493167233 193.2175133439342 475.1722756368512C169.40609631700477 451.6596560936715 173.76871717944056 202.98182751180946 168.06555139304055 69.29516382967336C166.25437178244263 44.156744253571475 178.84137849788414 25.89157356644773 209.60532657075984 27.26311714312319"
// "M760.1247173881754 155.7289156084096L822.1922437425667 156.4606978430149Q854.7813248672767 157.4277759955941 858.8567933230632 186.7486087493532Q869.4871691209406 329.9441497007053 859.4942029350283 474.27847855340315Q855.8778754232743 505.4724733508581 823.6558082117779 504.4795007175952L755.7919098199437 500.52365173390376Q734.5864345589571 495.61676701766993 736.2230271840905 466.10562190637Q737.338135784496 329.8559650046867 734.0957818942298 197.33243387453618Q731.2722308785432 158.81141143093285 760.5694147434392 155.44183072906836"
// "M86.69094409376206 156.6432197465873L147.3667214449654 155.47646357043263Q173.16660607563767 157.35673254214416 174.20378456820785 185.87830555198394Q175.82434114885552 335.7508762403353 171.545492471095 471.5561914133008Q170.37817927104518 503.90281269640803 144.25462894335942 501.3752123306698L73.2726910440883 502.9312585814729Q47.731961780584754 503.3845019620706 46.82491799549391 477.2609516343848Q41.379870165473776 323.3047343294921 49.80687578962032 187.0456187520337Q54.473343470343984 161.18066676762143 87.72812258633232 155.60604125401701"
//var sid = "";


var canvas1;
function CreateColor_init(id){
    var sid = MB.User.sid;
    var environment = MB.Content.find(id);
    var canvas = {
        scaleCoeff:0.33,
        scale:0.4,
        XCoeff:0,
        YCoeff:0,
        context:null,
        chairEtalon : new Image(),
        chairEtalon_ready: false,

        init : function(callback){
            this.chairEtalon.onload = function(){
                chairEtalon_ready = true;
                if (typeof callback=="function")
                    callback();
            };
            //this.chairEtalon.src = "upload/chairEtalon.png";
            this.chairEtalon.src = "upload/vvv3_sprite.png";
            this.context = $("#chair_prev_canvas")[0].getContext('2d');

            //$('#cp2').colorpicker();
            $('.colorpicker').colorpicker({
                format:"rgba"
            });
            $('#CP_mainCenter,#CP_mainPeriphery,#CP_hoverCenter,#CP_hoverPeriphery,#CP_selectedCenter,#CP_selectedPeriphery').colorpicker().on('changeColor', function(ev){
                var rgba = ev.color.toRGB();
                $(this).val("rgba("+rgba.r+","+rgba.g+","+rgba.b+","+rgba.a+")");
                $(this).css("backgroundColor",ev.color.toHex());
                canvas.drawChairs();
            });


        },
        // Функция отрисовки Path
        drawSVG : function(object,callback){
            var self = this;
            var context = object.ctx;
            var string = object.value;
            context.beginPath();
            (function execCommand(){
                if (!string.match(/[A-Z]/)){
                    //context.strokeStyle=object.color1;
                    context.fillStyle=object.color;
                    context.fill();
                    //context.stroke();

                    if (typeof callback=="function")
                        callback();

                    return;
                }
                var letter = string.match(/[A-Z]/)[0];
                string = string.replace(/\s*[A-Z]/,"");
                //log(letter[0]);
                var coor = string.match(/[^A-Z]+/)[0];
                string = string.replace(/[^A-Z]+/,"");
                var coors = coor.split(" ");

                for (var k in coors){
                    //coors[k] = +coors[k]*this.scaleCoeff;
                    if (k%2==0){
                        coors[k] = +coors[k]*self.scaleCoeff*self.scale+self.XCoeff*self.scale;
                    }else{
                        coors[k] = +coors[k]*self.scaleCoeff*self.scale+self.YCoeff*self.scale;
                    }
                }
                switch (letter){
                    case "M":

                        context.moveTo(coors[0],coors[1]);
                        break;
                    case "L":
                        context.lineTo(coors[0],coors[1]);
                        break;
                    case "Q":
                        context.quadraticCurveTo(coors[0],coors[1],coors[2],coors[3]);
                        break;
                    case "C":
                        context.bezierCurveTo(coors[0],coors[1],coors[2],coors[3],coors[4],coors[5]);
                        break;
                }
                execCommand();
            })();
        },
        drawChairs:function(){
            this.context.clearRect(0,0,360,120);
            this.XCoeff = 0;
            this.context.drawImage(this.chairEtalon,0,0,1200*this.scale,300*this.scale);
            this.drawSVG({
               /* value:"M207.8721324350939 27.917826920259323Q446.717838156399 32.35801629619725 697.399154427173 28.293540358259147C728.4574858652891 26.879503669871788 739.3640354115346 46.57634039943249 738.9979073128364 68.310207767613Q736.183031031041 222.51459110637822 724.8272712074668 431.9775942002012C725.8975804350478 466.0694784282333 716.2212511422277 468.85114399523 714.5967238030761 473.1512572414507C759.9782139308417 482.0423968880772 761.6350454138384 537.7279818981585 768.2270365134065 572.5477199864122C780.8273807948459 651.3315793520422 774.8659794687167 786.0475625285775 737.1572794378717 807.715886245039C699.3796580112419 830.8995063695895 555.821806114115 858.1093414717326 452.672308141119 865.3448080644633C354.685502981642 854.2243436652541 189.99930596978263 823.0828743930684 159.42486324448106 791.8210441457624C130.12700722230318 762.1985117105605 124.80377709111514 615.6430448164913 155.63616981752497 510.70380617856466C163.26817839724507 489.15230476915104 178.15898645081157 472.4310493167233 193.2175133439342 475.1722756368512C169.40609631700477 451.6596560936715 173.76871717944056 202.98182751180946 168.06555139304055 69.29516382967336C166.25437178244263 44.156744253571475 178.84137849788414 25.89157356644773 209.60532657075984 27.26311714312319",*/

                value:"M211.54493169317652 27.917826920259323Q447.9421045757599 38.47934839300165 699.8476872658948 28.293540358259147C730.9060187040109 26.879503669871788 741.8125682502564 46.57634039943249 741.4464401515582 68.310207767613Q734.9587646116801 218.8417918482956 727.2758040461886 431.9775942002012C728.3461132737696 466.0694784282333 718.6697839809495 468.85114399523 717.0452566417979 473.1512572414507C762.4267467695635 482.0423968880772 761.6350454138384 537.7279818981585 768.2270365134065 572.5477199864122C780.8273807948459 651.3315793520422 780.6074253722827 782.564706367114 743.7431055675602 808.3703233745422C699.3796580112419 830.8995063695895 555.821806114115 858.1093414717326 453.70663146386073 869.4821013554301C358.3703086353522 857.9091493189643 201.42945330458053 831.0989185662406 162.70977204557371 806.8834063496312C129.72711036968548 771.0549339779792 128.47657634919779 615.6430448164913 159.3089690756076 510.70380617856466C166.94097765532769 489.15230476915104 181.8317857088942 472.4310493167233 196.89031260201682 475.1722756368512C173.0788955750874 451.6596560936715 178.66578285688414 221.3458238022227 171.73835065112317 69.29516382967336C169.92717104052525 44.156744253571475 182.51417775596676 25.89157356644773 213.27812582884246 27.26311714312319",
                color: $('#CP_mainCenter').val(),
                ctx:this.context
            });
            this.drawSVG({
                /*value:"M760.1247173881754 155.7289156084096L822.1922437425667 156.4606978430149Q854.7813248672767 157.4277759955941 858.8567933230632 186.7486087493532Q869.4871691209406 329.9441497007053 859.4942029350283 474.27847855340315Q855.8778754232743 505.4724733508581 823.6558082117779 504.4795007175952L755.7919098199437 500.52365173390376Q734.5864345589571 495.61676701766993 736.2230271840905 466.10562190637Q737.338135784496 329.8559650046867 734.0957818942298 197.33243387453618Q731.2722308785432 158.81141143093285 760.5694147434392 155.44183072906836",*/
                value:"M760.1247173881754 155.7289156084096L822.1922437425667 156.4606978430149Q854.7813248672767 157.4277759955941 858.8567933230632 186.7486087493532Q869.4871691209406 329.9441497007053 859.4942029350283 474.27847855340315Q855.8778754232743 505.4724733508581 823.6558082117779 504.4795007175952L755.7919098199437 500.52365173390376Q734.5864345589571 495.61676701766993 736.2230271840905 466.10562190637Q737.338135784496 329.8559650046867 734.0957818942298 197.33243387453618Q731.2722308785432 158.81141143093285 760.5694147434392 155.44183072906836",
                color:$('#CP_mainPeriphery').val(),
                ctx:this.context
            });
            this.drawSVG({
                /*value: "M86.69094409376206 156.6432197465873L147.3667214449654 155.47646357043263Q173.16660607563767 157.35673254214416 174.20378456820785 185.87830555198394Q175.82434114885552 335.7508762403353 171.545492471095 471.5561914133008Q170.37817927104518 503.90281269640803 144.25462894335942 501.3752123306698L73.2726910440883 502.9312585814729Q47.731961780584754 503.3845019620706 46.82491799549391 477.2609516343848Q41.379870165473776 323.3047343294921 49.80687578962032 187.0456187520337Q54.473343470343984 161.18066676762143 87.72812258633232 155.60604125401701",*/
                value: "M86.69094409376206 156.6432197465873L147.3667214449654 155.47646357043263Q173.16660607563767 157.35673254214416 174.20378456820785 185.87830555198394Q175.82434114885552 335.7508762403353 171.545492471095 471.5561914133008Q170.37817927104518 503.90281269640803 144.25462894335942 501.3752123306698L73.2726910440883 502.9312585814729Q47.731961780584754 503.3845019620706 46.82491799549391 477.2609516343848Q41.379870165473776 323.3047343294921 49.80687578962032 187.0456187520337Q54.473343470343984 161.18066676762143 87.72812258633232 155.60604125401701",
                color:$('#CP_mainPeriphery').val(),
                ctx:this.context
            });


            //this.XCoeff = 300;
            //this.context.drawImage(this.chairEtalon,this.XCoeff*this.scale,0,300*this.scale,300*this.scale);
            this.drawSVG({
                value:"M211.54493169317652 27.917826920259323Q447.9421045757599 38.47934839300165 699.8476872658948 28.293540358259147C730.9060187040109 26.879503669871788 741.8125682502564 46.57634039943249 741.4464401515582 68.310207767613Q734.9587646116801 218.8417918482956 727.2758040461886 431.9775942002012C728.3461132737696 466.0694784282333 718.6697839809495 468.85114399523 717.0452566417979 473.1512572414507C762.4267467695635 482.0423968880772 761.6350454138384 537.7279818981585 768.2270365134065 572.5477199864122C780.8273807948459 651.3315793520422 780.6074253722827 782.564706367114 743.7431055675602 808.3703233745422C699.3796580112419 830.8995063695895 555.821806114115 858.1093414717326 453.70663146386073 869.4821013554301C358.3703086353522 857.9091493189643 201.42945330458053 831.0989185662406 162.70977204557371 806.8834063496312C129.72711036968548 771.0549339779792 128.47657634919779 615.6430448164913 159.3089690756076 510.70380617856466C166.94097765532769 489.15230476915104 181.8317857088942 472.4310493167233 196.89031260201682 475.1722756368512C173.0788955750874 451.6596560936715 178.66578285688414 221.3458238022227 171.73835065112317 69.29516382967336C169.92717104052525 44.156744253571475 182.51417775596676 25.89157356644773 213.27812582884246 27.26311714312319",
                color:$('#CP_hoverCenter').val(),
                ctx:this.context
            });
            this.drawSVG({
                value:"M760.1247173881754 155.7289156084096L822.1922437425667 156.4606978430149Q854.7813248672767 157.4277759955941 858.8567933230632 186.7486087493532Q869.4871691209406 329.9441497007053 859.4942029350283 474.27847855340315Q855.8778754232743 505.4724733508581 823.6558082117779 504.4795007175952L755.7919098199437 500.52365173390376Q734.5864345589571 495.61676701766993 736.2230271840905 466.10562190637Q737.338135784496 329.8559650046867 734.0957818942298 197.33243387453618Q731.2722308785432 158.81141143093285 760.5694147434392 155.44183072906836",
                color:$('#CP_hoverPeriphery').val(),
                ctx:this.context
            });
            this.drawSVG({
                value: "M86.69094409376206 156.6432197465873L147.3667214449654 155.47646357043263Q173.16660607563767 157.35673254214416 174.20378456820785 185.87830555198394Q175.82434114885552 335.7508762403353 171.545492471095 471.5561914133008Q170.37817927104518 503.90281269640803 144.25462894335942 501.3752123306698L73.2726910440883 502.9312585814729Q47.731961780584754 503.3845019620706 46.82491799549391 477.2609516343848Q41.379870165473776 323.3047343294921 49.80687578962032 187.0456187520337Q54.473343470343984 161.18066676762143 87.72812258633232 155.60604125401701",
                color:$('#CP_hoverPeriphery').val(),
                ctx:this.context
            });
            //this.XCoeff = 600;
            //this.context.drawImage(this.chairEtalon,this.XCoeff*this.scale,0,300*this.scale,300*this.scale);
            this.drawSVG({
                value:"M211.54493169317652 27.917826920259323Q447.9421045757599 38.47934839300165 699.8476872658948 28.293540358259147C730.9060187040109 26.879503669871788 741.8125682502564 46.57634039943249 741.4464401515582 68.310207767613Q734.9587646116801 218.8417918482956 727.2758040461886 431.9775942002012C728.3461132737696 466.0694784282333 718.6697839809495 468.85114399523 717.0452566417979 473.1512572414507C762.4267467695635 482.0423968880772 761.6350454138384 537.7279818981585 768.2270365134065 572.5477199864122C780.8273807948459 651.3315793520422 780.6074253722827 782.564706367114 743.7431055675602 808.3703233745422C699.3796580112419 830.8995063695895 555.821806114115 858.1093414717326 453.70663146386073 869.4821013554301C358.3703086353522 857.9091493189643 201.42945330458053 831.0989185662406 162.70977204557371 806.8834063496312C129.72711036968548 771.0549339779792 128.47657634919779 615.6430448164913 159.3089690756076 510.70380617856466C166.94097765532769 489.15230476915104 181.8317857088942 472.4310493167233 196.89031260201682 475.1722756368512C173.0788955750874 451.6596560936715 178.66578285688414 221.3458238022227 171.73835065112317 69.29516382967336C169.92717104052525 44.156744253571475 182.51417775596676 25.89157356644773 213.27812582884246 27.26311714312319",
                color:$('#CP_selectedCenter').val(),
                ctx:this.context
            });
            this.drawSVG({
                value:"M760.1247173881754 155.7289156084096L822.1922437425667 156.4606978430149Q854.7813248672767 157.4277759955941 858.8567933230632 186.7486087493532Q869.4871691209406 329.9441497007053 859.4942029350283 474.27847855340315Q855.8778754232743 505.4724733508581 823.6558082117779 504.4795007175952L755.7919098199437 500.52365173390376Q734.5864345589571 495.61676701766993 736.2230271840905 466.10562190637Q737.338135784496 329.8559650046867 734.0957818942298 197.33243387453618Q731.2722308785432 158.81141143093285 760.5694147434392 155.44183072906836",
                color:$('#CP_selectedPeriphery').val(),
                ctx:this.context
            });
            this.drawSVG({
                value: "M86.69094409376206 156.6432197465873L147.3667214449654 155.47646357043263Q173.16660607563767 157.35673254214416 174.20378456820785 185.87830555198394Q175.82434114885552 335.7508762403353 171.545492471095 471.5561914133008Q170.37817927104518 503.90281269640803 144.25462894335942 501.3752123306698L73.2726910440883 502.9312585814729Q47.731961780584754 503.3845019620706 46.82491799549391 477.2609516343848Q41.379870165473776 323.3047343294921 49.80687578962032 187.0456187520337Q54.473343470343984 161.18066676762143 87.72812258633232 155.60604125401701",
                color:$('#CP_selectedPeriphery').val(),
                ctx:this.context
            });
        },
        createImage:function(){
            $("#text_image").html($("#chair_prev_canvas")[0].toDataURL());

        },
        save_skin:function(){
            if ($("#text_image").html()=="") return;
            var name = ($("#name_skin").val()!="")? $("#name_skin").val() : "Новый";
            var params = MB.Core.makeQuery({command:"new",object:"chair_skin",sid:sid,params:{NAME:name,IMG:$("#text_image").html()}});
            $.post("/cgi-bin/b2cJ",{p_xml:params},function(data){
                log(data);
            })
        }
    };
    /// Инициализируем канвас
    var context  = $("#chair_prev_canvas")[0].getContext('2d');
    canvas.init(function(){
        canvas1 = canvas;
        $("#create_image").on("click",function(){
            canvas.createImage();
        });
        $("#save_skin").on("click",function(){
            canvas.save_skin();
        });
        /*requestAnimationFrame(function(){
            canvas.drawChairs();
        });*/
        //canvas.drawChairs();
    });




    ///









}



